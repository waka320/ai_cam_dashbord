# 目的ベースダッシュボードWebアプリケーション仕様書

## 1. プロダクト概要

### 1.1. コンセプト

本プロダクトは、遠藤・浦田研究室の「高山市におけるデータ地産地消プロジェクト」の一環として開発された目的ベースのダッシュボードです。AIカメラで収集した人流データを商店街の事業者が活用できるように設計されています。

特に「何をデータを使用してすれば良いのかわからない」という事業者の課題に対して、「目的を先に入力させてから、適切なデータを示す」という解決アプローチを採用しています。地域DX推進のためのデータ活用ツールとして、複数の可視化機能と直感的なインターフェースを提供します。

### 1.2. ターゲットユーザー

- 高山市の商店街事業者（主要ターゲット）
- 観光関連事業者
- 地方自治体の観光・商工担当者
- データ活用を検討している地域の事業者

### 1.3. 提供価値

- データ活用の敷居を下げる使いやすいインターフェース
- 目的から逆算したデータ提示による意思決定支援
- 人流データの視覚化による商業活動の最適化支援
- 地域事業者のDX促進と売上向上支援

## 2. 技術スタック

### 2.1. フロントエンド

- **フレームワーク:** React.js
- **UIライブラリ:** Material-UI（MUI）
- **状態管理:** コンテキストAPI（CalendarContext）
- **スタイリング:** MUIテーマとカスタムCSS
- **UI/コンポーネント:** カレンダー、ヒートマップなど
- **メディアクエリ:** レスポンシブデザイン対応
- **アイコン:** Material-UIアイコン
- **ビルドシステム:** Node.js v22.x
- **URL状態管理:** React Router、URLSearchParams

### 2.2. バックエンド

- **フレームワーク:** FastAPI（Python 3.12）
- **データ処理:** カスタム分析サービス（analyze/）
- **AI機能:** AIサービス（ai_service.py、ai_service_debug.py）
- **データ可視化:** ヒストグラム生成、ヒートマップなど
- **ハイライト機能:** highlighter_service.py
- **サーバー:** Uvicorn + Nginx

### 2.3. データソース

- **データ形式:** CSVファイル
- **取得方法:** 外部APIからのCSVデータ取得（fetch_csv.py）
- **保存場所:** ローカルディレクトリ構造
- **外部連携:** AWS S3からのデータ取得（exmeidai用）

### 2.4. インフラストラクチャー

- **フロントエンド:** Vercel（ホスティング）
- **バックエンド:** AWS EC2インスタンス
- **CI/CD:** GitHub Actions
- **API連携:** Gemini API（AIサービス用）
- **リバースプロキシ:** Nginx

## 3. 機能要件

### 3.1. 核となる機能

- **目的ベースの表示切替:** ユーザーの目的に合わせたデータ表示の切り替え
- **カレンダー形式の可視化:** 月間カレンダーでの混雑度表示
- **時間×曜日の可視化:** 曜日と時間帯の組み合わせによる混雑度マトリックス
- **日付×時間の可視化:** 特定月の日付と時間帯ごとの詳細な混雑度
- **AIによるデータ分析:** Gemini APIを使用した混雑度データの自動分析と提案
- **ハイライト機能:** 特徴的なデータポイントの自動強調表示

### 3.2. 新機能：URLパラメータによる状態共有

- **URLによる状態保存:** 選択した場所、アクション、年月のURLパラメータへの保存
- **共有機能:** 現在の表示状態のURLをクリップボードにコピーするボタン
- **ブックマーク対応:** ブックマークした際に状態を保持
- **初期値の設定:** URLパラメータから初期値を自動読み込み

### 3.3. ユーザーインターフェース要件

- **レスポンシブデザイン:** モバイル、タブレット、デスクトップに対応したレイアウト
- **直感的な操作性:** 目的別選択メニューによる簡単な操作
- **視覚的フィードバック:** データローディング時の表示、操作結果の通知
- **アクセシビリティ対応:** 基本的なWCAGガイドラインへの準拠

## 4. 非機能要件

### 4.1. パフォーマンス要件

- **初期読み込み時間:** 3秒以内（ネットワーク環境による）
- **データ更新応答時間:** 2秒以内
- **同時接続数:** 100ユーザー程度の同時アクセスに対応

### 4.2. セキュリティ要件

- **データ保護:** 個人情報を含まないデータ処理
- **APIアクセス制限:** 必要に応じたCORS設定
- **エラーハンドリング:** センシティブな情報を含まないエラーメッセージ

### 4.3. 可用性要件

- **稼働時間:** 24時間365日の基本稼働
- **バックアップ:** 定期的なデータバックアップ
- **障害復旧:** 障害時の復旧手順の整備

### 4.4. 保守性要件

- **コード品質:** クリーンなコード構造と適切なコメント
- **モジュール化:** 機能ごとの明確な分離と再利用可能なコンポーネント
- **ドキュメント:** コードと機能の適切なドキュメント化

## 5. コンポーネント構成

### 5.1. Contextとルーター

- **CalendarContext:**
  - 各種選択状態の管理（場所、アクション、年月）
  - URLパラメータとの連携
  - APIリクエストのハンドリング
  - レースコンディション対策（AbortController使用）
  
- **Router設定:**
  - URLパラメータの読み取りと状態反映
  - 履歴管理との連携

### 5.2. 共通コンポーネント

- **Calendar.js:** カレンダー形式の混雑度表示
- **TimeHeatmap.js:** 曜日×時間の混雑度ヒートマップ
- **DateTimeHeatmap.js:** 日付×時間の混雑度ヒートマップ
- **CongestionLegend.js:** 混雑度の凡例表示
- **HeatmapPopper.js:** セル選択時の詳細ポップアップ
- **SelectionControls.js:** 表示制御用のセレクター群

### 5.3. レイアウトコンポーネント

- **Header.js:** ナビゲーションとメイン選択UI
- **Content.js:** メインコンテンツエリア
- **AISection.js:** AI分析結果表示エリア

### 5.4. UI/ユーティリティコンポーネント

- **ShareButton.js:** 現在の表示状態を共有するためのボタン
  - クリップボード機能
  - モバイル向けWeb Share API対応
  - 各種フィードバック表示
- **SectionContainer.js:** コンテンツセクションのラッパー
- **ScrollContainer.js:** スクロール可能なコンテナ

## 6. APIエンドポイント

### 6.1. グラフデータ取得

**エンドポイント:** `/api/get-graph`
**メソッド:** POST
**リクエスト:**

```json
{
  "place": "string",
  "action": "string",
  "year": "number",
  "month": "number"
}
```

**レスポンス:**

```json
{
  "calendar_data": [...],
  "time_data": [...],
  "date_time_data": [...],
  "highlights": {...}
}
```

### 6.2. AIアドバイス生成

**エンドポイント:** `/api/analyze-csv`
**メソッド:** POST
**リクエスト:**

```json
{
  "csvData": "string",
  "question": "string"
}
```

**レスポンス:**

```json
{
  "analysis": "string",
  "recommendations": "string"
}
```

### 6.3. データ取得エンドポイント

- **CSVデータ取得:** `/api/fetch-csv` (GET)
- **拡張データ取得:** `/api/fetch-csv-exmeidai` (GET)

## 7. デプロイメント構成

### 7.1. フロントエンドデプロイ（Vercel）

- **自動デプロイ:** GitHub Actionsワークフロー（ci_front.yaml）
- **ビルドプロセス:**
  - Node.js 22.xセットアップ
  - 依存関係インストール（npm ci）
  - ビルド実行（npm run build）
  - Vercelへの自動デプロイ
- **環境変数:** Vercel環境で設定

### 7.2. バックエンドデプロイ（AWS EC2）

- **自動デプロイ:** GitHub Actionsワークフロー（ci_back.yaml）
- **デプロイプロセス:**
  - コードをSSH経由でEC2インスタンスに転送
  - Python仮想環境の更新
  - 依存関係インストール
  - Uvicornサーバー再起動（ポート8000）
  - Nginx設定確認と再読み込み
- **実行環境:** Python 3.12仮想環境
- **エラーログ:** app.logファイル

### 7.3. システム構成図

```
[ユーザー] --> [Vercel (フロントエンド)] --> [AWS EC2 (バックエンド API)] --> [CSVデータストア]
                                          |
                                          v
                                    [Gemini API]
```

## 8. 今後の開発計画

### 8.1. 短期的な改善点

- **コードの重複解消:** 可視化コンポーネント間の共通処理の抽出
- **状態管理の最適化:** CalendarContext内のレースコンディション対策の強化
- **エラーハンドリングの強化:** ユーザーへの適切なエラー表示
- **URLパラメータ機能の拡張:** より多くのパラメータのサポート（表示モードなど）

### 8.2. 中長期的な開発計画

- **データベース導入:** CSVからデータベースへの移行
- **ユーザー認証:** 地域事業者向けのログイン機能
- **カスタムダッシュボード:** ユーザーごとの表示カスタマイズ
- **他地域への展開:** 他の商店街・地域への横展開対応
- **予測分析:** 将来の混雑度予測機能の追加
- **インタラクティブな分析:** ユーザーによるデータ操作・分析機能

### 8.3. テクニカルデット解消

- **テスト導入:** ユニットテスト、インテグレーションテストの整備
- **コンポーネントのリファクタリング:** より再利用性の高い構造への改善
- **パフォーマンス最適化:** 大規模データセット対応のための最適化
- **アクセシビリティ改善:** より広範なユーザーへの対応

## 9. 開発環境とリソース

- **コードリポジトリ:** GitHub
- **デザインリソース:** Figma (<https://www.figma.com/design/C8bbdecPpwqYXlfJxEWouf/Untitled?node-id=0-1&t=zrU2JK2cVNs5sWGY-1>)
- **デプロイ環境:** Vercel (フロントエンド), AWS EC2 (バックエンド)
- **旧バージョン参照:** <http://35.73.95.100:81/>
- **フロントエンド閲覧:** <https://ai-cam-dashbord.vercel.app/>

## 10. ディレクトリ構成

プロジェクトは機能とレイヤーを明確に分離した構成を採用しています。

### 10.1. バックエンド構成

```
backend/
├── app/
│   ├── api/
│   │   └── endpoints/         # 各APIエンドポイントの実装
│   │       ├── csv_analysis.py
│   │       ├── fetch_csv.py
│   │       ├── get_graph.py
│   │       └── ...
│   ├── core/                  # 共通設定・環境変数
│   │   └── config.py
│   ├── services/              # ビジネスロジック層
│   │   ├── ai_service.py      # AI分析機能
│   │   ├── highlighter_service.py  # データハイライト機能
│   │   └── analyze/           # データ分析モジュール群
│   │       ├── analyze_weather.py
│   │       ├── analyze_event.py
│   │       ├── get_data_for_calendar.py
│   │       └── ...
│   └── main.py                # アプリケーションのエントリーポイント
└── run.py                     # サーバー起動スクリプト
```

### 10.2. フロントエンド構成

```
frontend/
├── public/                    # 静的ファイル
│   ├── assets/                # ロゴなどの画像
│   └── fonts/                 # カスタムフォント
└── src/
    ├── assets/                # ソースコード内で使用する静的ファイル
    ├── components/            # React コンポーネント
    │   ├── common/            # 汎用的なコンポーネント
    │   │   ├── Calendar.js    # カレンダー表示コンポーネント
    │   │   ├── TimeHeatmap.js # 時間ヒートマップ
    │   │   └── ...
    │   ├── layout/            # レイアウト構造を定義
    │   │   ├── Header.js      # ヘッダーコンポーネント
    │   │   ├── Content.js     # メインコンテンツエリア
    │   │   └── AISection.js   # AI分析セクション
    │   └── ui/                # 基本UI要素
    │       ├── ShareButton.js # 共有ボタン
    │       └── ...
    ├── contexts/              # Reactコンテキスト
    │   └── CalendarContext.js # カレンダー関連状態管理
    ├── styles/                # グローバルスタイル
    ├── theme/                 # MUIテーマ設定
    │   └── theme.js
    └── utils/                 # ユーティリティ関数
```

この仕様書は今後のプロジェクト進行に伴い継続的に更新されます。
